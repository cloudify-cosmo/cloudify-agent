#! /bin/bash -e

{% if add_ssl_cert %}
add_ssl_cert()
{
    # Create all the directories in the path to the cert file
    mkdir -p $(dirname {{ ssl_cert_path }})
    echo "{{ ssl_cert_content }}" > {{ ssl_cert_path }}
}
export -f add_ssl_cert
{% endif %}

export_daemon_env()
{
    export_agent_cli_env
    {% for env_key, env_value in daemon_env.iteritems() %}
        export {{ env_key }}={{ env_value }}
    {% endfor %}
}
export -f export_daemon_env

#####################################################
###################### Install ######################
#####################################################

{% if install %}
download()
{
    echo "Downloading $1..."
    if command -v wget > /dev/null 2>&1; then
        wget $1 -O $2 --header="{{ auth_token_header }}: {{ auth_token_value }}" --ca-certificate {{ ssl_cert_path }}
    elif command -v curl > /dev/null 2>&1; then
        STATUS_CODE=$(curl -L -o $2 --write-out "%{http_code}" $1 -H "{{ auth_token_header }}: {{ auth_token_value }}" --cacert {{ ssl_cert_path }})
        if [ "${STATUS_CODE}" -ne "200" ] ; then
            echo >&2 "Received unexpected HTTP response code (${STATUS_CODE}). Response data was saved into $2."
            return 1
        fi
    else
        echo >&2 "error: wget/curl not found. cannot download agent package"; return 1
    fi
    echo "Download ended successfully"
}
export -f download

package_url()
{
    if [[ ! -z "{{ conf.package_url }}" ]]; then
        echo "{{ conf.package_url }}"
    else
        local distro="$(python -c 'import sys, platform; sys.stdout.write(platform.dist()[0].lower())')"
        local distro_codename="$(python -c 'import sys, platform; sys.stdout.write(platform.dist()[2].lower())')"
        echo "{{ file_server_url }}/packages/agents/${distro}-${distro_codename}-agent.tar.gz"
    fi
}
export -f package_url

download_and_extract_agent_package()
{
    download $(package_url) {{ conf.basedir }}/agent.tar.gz
    mkdir -p {{ conf.agent_dir }}
    tar xzf {{ conf.basedir }}/agent.tar.gz --strip=1 -C {{ conf.agent_dir }}
}
export -f download_and_extract_agent_package

install_agent()
{
    {% if add_ssl_cert %}
    su {{ conf.user }} --shell /bin/bash -c "set -e; add_ssl_cert"
    {% endif %}
    su {{ conf.user }} --shell /bin/bash -c "set -e; download_and_extract_agent_package"
}
export -f install_agent
{% endif %}

#######################################################
###################### Configure ######################
#######################################################

{% if configure %}

configure_virtualenv()
{
    echo "[configure_virtualenv] Starting..." >> /tmp/adi.log
    export_daemon_env
    # configure command is run explicily as the virtualenv has not been "fixed"
    # yet
    ${AGENT_PYTHON_INTERPRETER} ${AGENT_CLI} configure --relocated-env
    echo "[configure_virtualenv] Done..." >> /tmp/adi.log
}
export -f configure_virtualenv

disable_requiretty()
{
    echo "[disable_requiretty] Starting..." >> /tmp/adi.log
    {% if conf.disable_requiretty %}
        export_daemon_env
        cfy-agent configure --disable-requiretty --no-sudo
    {% else %}
        echo "Skipping disable_requiretty part"
    {% endif %}
    echo "[disable_requiretty] Done..." >> /tmp/adi.log
}
export -f disable_requiretty

configure_agent()
{
    su {{ conf.user }} --shell /bin/bash -c "set -e; configure_virtualenv"
    disable_requiretty
}
export -f configure_agent
{% endif %}

###################################################
###################### Start ######################
###################################################

{% if start %}
create_custom_env_file()
{
    echo "[create_custom_env_file] Starting..." >> /tmp/adi.log
    {% if custom_env is not none %}
    cat <<EOF > {{ custom_env_path }}
#!/bin/bash
{% for env_key, env_value in custom_env.iteritems() %}
export {{ env_key }}="{{ env_value }}"
{% endfor %}
EOF
    {% else %}
        echo "No custom env configured"
    {% endif %}
    echo "[create_custom_env_file] Done..." >> /tmp/adi.log
}
export -f create_custom_env_file

start_daemon()
{
    echo "[start_daemon] Starting..." >> /tmp/adi.log
    export_daemon_env
    cfy-agent daemons create {{ pm_options }} {% if transfer_agent %}--agents-transfer-mode {%endif%}
    echo "[start_daemon] After cfy-agent daemons create..." >> /tmp/adi.log
    cfy-agent daemons configure
    echo "[start_daemon] After cfy-agent daemons configure..." >> /tmp/adi.log
    {% if not transfer_agent %}
    cfy-agent daemons start
    {% endif %}
    echo "[start_daemon] Done..." >> /tmp/adi.log
}
export -f start_daemon

start_agent()
{
    echo "[start_agent] Starting..." >> /tmp/adi.log
    su {{ conf.user }} --shell /bin/bash -c "set -e; create_custom_env_file"
    su {{ conf.user }} --shell /bin/bash -c "set -e; start_daemon"
    echo "[start_agent] Done..." >> /tmp/adi.log
}
export -f start_agent
{% endif %}

###################################################
################# Transfer Agent ##################
###################################################

export_agent_cli_env()
{
    echo "[export_agent_cli_env] Starting..." >> /tmp/adi.log
    local agent_env_bin={{ conf.envdir }}/bin
    export AGENT_PYTHON_INTERPRETER=${agent_env_bin}/python
    export AGENT_CLI=${agent_env_bin}/cfy-agent
    export PATH=${agent_env_bin}:$PATH
    export CLOUDIFY_DAEMON_NAME={{ conf.name }}
    echo "[export_agent_cli_env] Done..." >> /tmp/adi.log

}
export -f  export_agent_cli_env


transfer_agent()
{
    echo "[transfer_agent] Starting..." >> /tmp/adi.log
    echo "starting transfer_agent..."
    su {{ conf.user }} --shell /bin/bash -c "set -e; add_ssl_cert"
    echo "[transfer_agent] Done..." >> /tmp/adi.log


}
export -f transfer_agent

main()
{
    {% if transfer_agent %}
    transfer_agent
    {% endif %}
    {% if install %}
    install_agent
    {% endif %}
    {% if configure %}
    configure_agent
    {% endif %}
    {% if start %}
    start_agent
    {% endif %}
    {% if transfer_agent %}
    #/etc/init.d/celeryd-{{ conf.name }} try-restart
    # sleep 5 && /etc/init.d/celeryd-{{ conf.name }} try-restart &
    # sleep 5 && /etc/init.d/celeryd-{{ conf.name }} kill &
    echo "[transfer_agent] *************** BEFORE kill -9 ***************" >> /tmp/adi.log
    ps aux | grep celery >> /tmp/adi.log
    #sleep 5 && ps -ef | grep celery | grep -v grep | awk '{print $2}' | xargs kill -9 &
    sleep 5 && /etc/init.d/celeryd-{{ conf.name }} try-restart &
    echo "[transfer_agent] *************** AFTER kill -9 ***************" >> /tmp/adi.log
    {% endif %}
    echo "[main] Done !!!" >> /tmp/adi.log
}
export -f main

main
