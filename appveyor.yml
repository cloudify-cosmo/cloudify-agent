environment:

  TOX_ENV: pywin

  rabbitmq_download_url: https://www.rabbitmq.com/releases/rabbitmq-server/v3.5.2/rabbitmq-server-3.5.2.exe
  rabbitmq_installer_path: C:\Users\appveyor\rabbitmq.exe

  matrix:
    - PYTHON: C:\Python27
      PYTHON_VERSION: 2.7.8
      PYTHON_ARCH: 32

cache:
  - C:\Temp\choco
  - "%rabbitmq_installer_path%"
  - C:\Users\appveyor\.tox


install:

  #################################
  # Change Python Registry
  #################################

  - reg ADD HKCU\Software\Python\PythonCore\2.7\InstallPath /ve /d "C:\Python27" /t REG_SZ /f
  - reg ADD HKLM\Software\Python\PythonCore\2.7\InstallPath /ve /d "C:\Python27" /t REG_SZ /f

  #################################
  # Installing Inno Setup
  #################################

  - choco config set cacheLocation C:\Temp\choco
  - choco install -y InnoSetup
  - set PATH="C:\\Program Files (x86)\\Inno Setup 5";%PATH%

  #################################
  # Download and install RabbitMQ
  #################################

  - echo Downloading Rabbit...
  - ps: $webclient = New-Object System.Net.WebClient
  - ps: >
        if (-Not (Test-Path "$env:rabbitmq_installer_path")) {
          $webclient.DownloadFile("$env:rabbitmq_download_url", "$env:rabbitmq_installer_path")
        } else {
          Write-Host "Found" $env:rabbitmq_installer_path "in cache."
        }
  - echo Installing Rabbit...
  - start /B /WAIT %rabbitmq_installer_path% /S
  - ps: (Get-Service -Name RabbitMQ).Status

  - SET PATH=%PYTHON%;%PYTHON%\\Scripts;%PATH%

  - echo Upgrading pip...
  - ps: $webclient.Downloadfile('https://bootstrap.pypa.io/get-pip.py', 'C:\Users\appveyor\get-pip.py')
  - ps: Start-Process -FilePath "C:\Python27\python.exe" -ArgumentList "C:\Users\appveyor\get-pip.py" -Wait -Passthru
  - pip --version

build: false # Not a C# project, build stuff at the test step instead.

before_test:
  - pip install virtualenv --upgrade
  - virtualenv --version
  - virtualenv env
  - 'env\Scripts\activate.bat'
  - echo Installing tox
  - pip install tox

test_script:
  - tox -e %TOX_ENV%
